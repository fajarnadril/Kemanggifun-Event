<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tenant Add Score</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: #080A1A;
      color: #E0E7FF;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }
    .card {
      background: #0D162A;
      border: 1px solid #081B34;
      border-radius: 12px;
      padding: 24px;
      max-width: 480px;
      width: 100%;
      box-shadow: 0 0 30px rgba(0,228,255,0.12);
    }
    .suggestions {
      position: absolute;
      background: #0D162A;
      border: 1px solid #00566e;
      width: 100%;
      max-height: 200px;
      overflow-y: auto;
      z-index: 10;
      border-radius: 0 0 6px 6px;
    }
    .suggestions div {
      padding: 8px 12px;
      cursor: pointer;
    }
    .suggestions div:hover {
      background-color: #00B8D9;
      color: #0D162A;
    }
    .popup {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #0D162A;
      padding: 14px 20px;
      border-radius: 6px;
      border-left: 4px solid #00E4FF;
      color: #E0E7FF;
      display: none;
      z-index: 9999;
    }
    .popup.error {
      border-left-color: #FF00FF;
      color: #FF00FF;
    }
    .btn-disabled {
      background: #334155 !important;
      cursor: not-allowed !important;
      opacity: 0.7;
    }
  </style>
</head>
<body>

  <div class="card">
    <h2 class="text-xl font-bold text-center text-cyan-400 mb-6">Add Score</h2>
    <form id="scoreForm" class="space-y-4" autocomplete="off">
      <div>
        <label class="block text-sm font-semibold text-cyan-400">Nama Acara</label>
        <input type="text" id="event_name" class="w-full p-2 rounded bg-[#081B34] border border-cyan-700" readonly />
      </div>
      <div>
        <label class="block text-sm font-semibold text-cyan-400">Nama Tenant</label>
        <input type="text" id="tenant_name" class="w-full p-2 rounded bg-[#081B34] border border-cyan-700" readonly />
      </div>
      <div class="relative">
        <label class="block text-sm font-semibold text-cyan-400">Email Pengunjung</label>
        <input type="text" id="email_input" class="w-full p-2 rounded bg-[#081B34] border border-cyan-700" placeholder="Ketik email..." />
        <div id="email_suggestions" class="suggestions hidden"></div>
      </div>
      <button type="submit" id="addScoreBtn" class="bg-cyan-400 text-black font-bold rounded px-4 py-2 w-full">➕ Add Score</button>
    </form>
  </div>

  <div id="popup" class="popup"><span id="popup-message"></span></div>

  <script>
    const BASE_URL = 'https://script.google.com/macros/s/AKfycbzBknnzKMS3h9SCuhIpLRXOTzT1aib7BAO-4wEKmLR0bqQqu0ijcqBXnXzMSCLs7HllWQ/exec';
    let allEmails = [];

    function showPopup(msg, isError = false) {
      const popup = document.getElementById('popup');
      const msgSpan = document.getElementById('popup-message');
      msgSpan.textContent = msg;
      popup.className = 'popup' + (isError ? ' error' : '');
      popup.style.display = 'block';
      setTimeout(() => popup.style.display = 'none', 5000);
    }

    async function fetchEmails() {
      try {
        const res = await fetch(BASE_URL);
        const data = await res.json();
        allEmails = (data.emails || []).map(e => e.toLowerCase());
      } catch (err) {
        showPopup('❌ Gagal ambil email: ' + err.message, true);
      }
    }

    function setupAutocomplete() {
      const input = document.getElementById('email_input');
      const box = document.getElementById('email_suggestions');

      input.addEventListener('input', () => {
        const q = input.value.trim().toLowerCase();
        box.innerHTML = '';
        if (!q) return box.classList.add('hidden');

        const matched = allEmails.filter(e => e.includes(q)).slice(0, 10);
        matched.forEach(email => {
          const div = document.createElement('div');
          div.textContent = email;
          div.onclick = () => {
            input.value = email;
            box.classList.add('hidden');
          };
          box.appendChild(div);
        });
        box.classList.toggle('hidden', matched.length === 0);
      });

      document.addEventListener('click', (e) => {
        if (!box.contains(e.target) && e.target !== input) {
          box.classList.add('hidden');
        }
      });
    }

    document.getElementById('scoreForm').addEventListener('submit', async function (e) {
      e.preventDefault();

      const btn = document.getElementById('addScoreBtn');
      const email = document.getElementById('email_input').value.trim().toLowerCase();
      const tenant = document.getElementById('tenant_name').value;
      const eventName = document.getElementById('event_name').value;

      if (!email) return showPopup('❌ Email harus diisi.', true);
      if (!allEmails.includes(email)) return showPopup('❌ Email tidak ditemukan di daftar.', true);

      // Aktifkan cooldown (disable tombol)
      btn.disabled = true;
      btn.classList.add('btn-disabled');
      btn.textContent = '⏳ Mengirim...';

      const formData = new FormData();
      formData.append('EventName', eventName);
      formData.append('TenantName', tenant);
      formData.append('Email_Visitor', email);

      try {
        const res = await fetch(BASE_URL, { method: 'POST', body: formData });
        const result = await res.json();

        if (result.result === 'success') {
          showPopup('✅ Score ditambahkan untuk: ' + email);
          document.getElementById('email_input').value = '';
        } else {
          showPopup('❌ Gagal: ' + (result.message || 'Unknown error'), true);
        }
      } catch (err) {
        showPopup('❌ Gagal kirim: ' + err.message, true);
      } finally {
        // Hapus cooldown setelah respon (sukses atau error)
        btn.disabled = false;
        btn.classList.remove('btn-disabled');
        btn.textContent = '➕ Add Score';
      }
    });

    window.onload = async () => {
      const params = new URLSearchParams(location.search);
      document.getElementById('event_name').value = params.get('event') || 'TechManDay';
      document.getElementById('tenant_name').value = params.get('tenant') || 'GAT';
      await fetchEmails();
      setupAutocomplete();
    };
  </script>

</body>
</html>
